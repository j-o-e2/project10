/**
 * Email Verification Debugging Guide
 * Run this to identify why verification links are expiring
 */

console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         EMAIL VERIFICATION EXPIRY DIAGNOSTIC GUIDE             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If OTP is set to 24 hours but links still expire quickly, check:

ğŸ“‹ STEP 1: EMAIL TEMPLATE REDIRECT URL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Supabase Dashboard â†’ Authentication â†’ Email Templates â†’ Confirm signup

The template should contain:
  {{ .ConfirmationURL }}

This URL is generated by Supabase and should redirect to /api/auth/callback

âŒ WRONG: If it shows a hardcoded URL like:
  https://yourapp.com/confirm?token=...
  (This bypasses /api/auth/callback and loses session)

âœ… RIGHT: Should auto-generate based on Site URL + /api/auth/callback


ğŸ“‹ STEP 2: SUPABASE SITE URL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Supabase Dashboard â†’ Settings â†’ General â†’ Site URL

Must match your current deployment URL EXACTLY:
  - Local dev: http://localhost:3000
  - Production: https://yourdomain.com
  - Vercel: https://yourapp.vercel.app

âŒ PROBLEM: If Site URL is wrong, Supabase generates invalid callback URLs


ğŸ“‹ STEP 3: SUPABASE REDIRECT URLS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Supabase Dashboard â†’ Authentication â†’ URL Configuration

Add ALL these (including wildcards):
  - http://localhost:3000/**
  - http://localhost:3000
  - https://yourdomain.com/**
  - https://yourdomain.com

âŒ PROBLEM: If /api/auth/callback is not in allowed redirects, it will fail


ğŸ“‹ STEP 4: TOKEN TYPE CHECK
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Two different token types exist:

1. "Confirmation Token" (signUp with password)
   - Expiry: Cannot be configured per-project (hardcoded 24h by Supabase)
   - Used by: /api/auth/signup (Password-based signup)

2. "OTP Token" (magic link / signInWithOtp)
   - Expiry: Configurable to 24 hours
   - Used by: /api/auth/resend-verification (Magic link)

Your signup is using CONFIRMATION TOKEN (type 1), which has its own 24h timer.
The 24h OTP setting you changed is only for magic links (type 2).

âŒ LIKELY PROBLEM: Even though OTP is 24h, your confirmation emails use
   a different token system with a MUCH SHORTER expiry (possibly 15-60 min).


ğŸ“‹ SOLUTION OPTIONS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

OPTION A: Use Magic Links Instead of Password Signup (RECOMMENDED)
  - Change signup to use signInWithOtp (magic link only)
  - No password needed, link expiry is configurable to 24 hours
  - Simpler, more reliable, already tested

OPTION B: Auto-Confirm Email on Signup (For Testing/MVP)
  - Use service role to mark email as confirmed immediately
  - Users don't wait for email confirmation
  - Good for MVP, but less secure

OPTION C: Implement Refresh Token for Expired Links
  - User gets new link sent to their email
  - This is already implemented (/api/auth/resend-verification)
  - User clicks new link before it expires

RECOMMENDED: Use OPTION C (already implemented) while you decide on A or B


ğŸ”§ QUICK FIX - Test Magic Link Flow
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Your signup-success page already has a "Resend Verification Email" button.
This uses magic links (OTP) which should work for 24 hours.

Try this:
1. Sign up with email/password
2. When you see "Token Expired" on first link
3. Use "Resend Verification Email" button
4. Click the NEW link - this should work for 24 hours

If the resent link ALSO expires quickly, then the problem is:
  - Site URL mismatch in Supabase
  - Email template not configured correctly
  - Network/DNS issues

`)
